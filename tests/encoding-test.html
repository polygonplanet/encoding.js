<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Converts character encoding in JavaScript - encoding.js</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://unpkg.com/encoding-japanese@2.1.0/encoding.min.js"></script>
<script>
(function() {
  'use strict';

  var ENCODINGS = ['SJIS', 'JIS', 'EUCJP', 'UTF8'];

  $(document).ready(doit);

  function doit() {
    var run = document.getElementById('run');
    run.removeAttribute('disabled');
    run.addEventListener('click', function() {
      run.disabled = true;
      convert();
    }, false);
  }

  function convert() {
    var d = $.Deferred();

    ENCODINGS.forEach(function(encodingName) {
      d.then(function() {
        var filename = 'encoding-' + encodingName.toLowerCase() + '.txt';

        return readFile(filename).then(function(data) {
          appendTitle('Open ', filename);

          appendText(encodingName + ' Array', Array.prototype.slice.call(data).toString());
          appendText(encodingName + ' String', Encoding.codeToString(data));

          var detected = Encoding.detect(data);
          appendText('Encoding.detect(' + encodingName +' Array)', detected);

          var encoded = Encoding.urlEncode(data);
          appendText('Encoding.urlEncode(' + encodingName + ' Array)', encoded);

          var decoded = Encoding.urlDecode(encoded);
          appendText('Encoding.urlDecode()', decoded.toString());

          // Convert to Unicode.
          var unicode = Encoding.convert(data, {
            to: 'UNICODE',
            from: 'AUTO'
          });

          appendText(encodingName + ' Array => UNICODE Array', unicode.toString());
          appendText('UNICODE Array => UNICODE String', Encoding.codeToString(unicode));
        }, function(err) {
          appendTitle('Open ', filename);
          appendText('Error', err);
          console.error(err);
          throw err;
        });
      });
    });

    d.resolve();
  }

  function readFile(url) {
    var d = $.Deferred();
    var req = new XMLHttpRequest();
    req.open('GET', url, true);
    req.responseType = 'arraybuffer';

    req.onload = function(ev) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          var buffer = req.response;
          if (buffer) {
            var data = new Uint8Array(buffer);
            d.resolve(data);
          } else {
            d.reject(req.statusText);
          }
        } else {
          d.reject(req.statusText);
        }
      }
    };

    req.onerror = function(ev) {
      d.reject(req.statusText);
    };

    req.send(null);

    return d;
  }

  function appendTitle(title, url) {
    var a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.textContent = url;

    var h3 = document.createElement('h3');
    h3.appendChild(document.createTextNode(title));
    h3.appendChild(a);

    var result = document.getElementById('result');
    result.appendChild(h3);
  }

  function appendText(title, text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(title));

    var textarea = document.createElement('textarea');
    textarea.value = text;

    var result = document.getElementById('result');
    result.appendChild(div);
    result.appendChild(textarea);
  }

}());
</script>
<style>
* {
  font-family: tahoma, verdana, sans-serif;
}

textarea {
  width: 98%;
  height: 2.5em;
  font-family: consolas, monospace;
}

.container {
  margin-left: 5em;
  margin-right: 5em;
  margin-top: 100px;
  margin-bottom: 1em;
}

#run {
  font-size: 120%;
  font-weight: bold;
}

footer {
  margin: 0.5em auto;
  margin-top: 2em;
  font-weight: bold;
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Converts character encoding in JavaScript</h1>
      <h2><a href="https://github.com/polygonplanet/encoding.js">encoding.js</a>を使って文字コードを変換します</h2>
      <div class="description">
        いろいろな文字コードで書かれているテキストを取得して、文字コードを変換して表示します。
      </div>
    </header>
    <div class="wrapper">
      <div>
        <button type="button" id="run" disabled="disabled">Run</button>
      </div>
      <div id="result"></div>
    </div>
    <footer>
      <a href="https://github.com/polygonplanet/encoding.js">Repository in GitHub</a>
    </footer>
  </div>
  <a href="https://github.com/polygonplanet/encoding.js"><img style="position: absolute; top: 0; left: 0; border: 0;" decoding="async" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_left_green_007200.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" loading="lazy" data-recalc-dims="1"></a>
</body>
</html>